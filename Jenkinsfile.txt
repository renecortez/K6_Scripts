pipeline {
  agent any
  options { ansiColor('xterm'); timestamps() }

  environment {
    K6_BIN = '"C:\\Program Files\\k6\\k6.exe"'
  }

  stages {
    stage('Checkout') {
      steps {
        // En multibranch Jenkins ya hace checkout autom√°ticamente,
        // pero lo dejamos por claridad; puedes quitarlo si quieres.
        checkout scm
      }
    }

    stage('Run k6 (Windows)') {
      steps {
        bat '''
        set K6_WEB_DASHBOARD=true
        set K6_WEB_DASHBOARD_OPEN=false
        set K6_WEB_DASHBOARD_EXPORT=%WORKSPACE%\\report.html

        %K6_BIN% version
        %K6_BIN% run Scripts\\QuickPizza1.js --summary-export %WORKSPACE%\\summary.json
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'report.html, summary.json', fingerprint: true, onlyIfSuccessful: false
      publishHTML(target: [
        reportDir: '.',
        reportFiles: 'report.html',
        reportName: 'k6 Dashboard',
        allowMissing: true,
        alwaysLinkToLastBuild: true,
        keepAll: true
      ])
    }
  }
}
